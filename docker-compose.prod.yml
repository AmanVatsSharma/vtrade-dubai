version: "3.9"

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vtrade-web
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    ports:
      # Host-level NGINX proxies to this.
      - "127.0.0.1:3000:3000"
    healthcheck:
      # Uses Node 20 built-in fetch; /api/ready also pings DB.
      test:
        [
          "CMD-SHELL",
          "node -e \"fetch('http://localhost:3000/api/ready').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\"",
        ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

  order-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vtrade-order-worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - ORDER_WORKER_INTERVAL_MS=750
      - ORDER_WORKER_BATCH_LIMIT=50
    depends_on:
      web:
        condition: service_healthy
    command: ["pnpm", "tsx", "scripts/order-worker.ts"]

  position-pnl-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vtrade-position-pnl-worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - POSITION_PNL_WORKER_INTERVAL_MS=3000
      - POSITION_PNL_WORKER_BATCH_LIMIT=500
      - POSITION_PNL_UPDATE_THRESHOLD=1
    depends_on:
      web:
        condition: service_healthy
    command: ["pnpm", "tsx", "scripts/position-pnl-worker.ts"]

